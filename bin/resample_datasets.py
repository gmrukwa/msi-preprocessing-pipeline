# -*- coding: utf-8 -*-
"""
Created on Sat May 19 17:30:28 2018

Resample datasets to common m/z axis

First argument: path to new m/z axis file. Should be generated by
    estimate_resampling_axis.

Further arguments: paths to datasets to be resampled.

@author: Grzegorz Mrukwa
"""

from functools import partial
import os
import sys

import numpy as np

from functional import as_arguments_of, broadcast, for_each, pipe, progress_bar
from io_utils import text_files


def spectrum_sampling_pipe(mzs):
    return pipe(
        np.loadtxt,
        np.transpose,
        as_arguments_of(partial(np.interp, mzs)),
        np.ravel,
        partial(np.ndarray.astype, dtype=np.float32)
    )


def dataset_sampling_pipe(mzs):
    return pipe(
        text_files, list,
        progress_bar('resampling dataset'),
        for_each(spectrum_sampling_pipe(mzs), parallel=True, chunksize=800)
    )


def result_filename(dataset_path):
    return os.path.join(dataset_path, 'resampled_spectra.npy')


def resampling_and_saving_pipe(mzs):
    return pipe(
        broadcast(
            result_filename,
            dataset_sampling_pipe(mzs)
        ),
        as_arguments_of(np.save)
    )


def resampling_pipeline(mzs):
    return pipe(
        progress_bar('processing datasets'),
        for_each(resampling_and_saving_pipe(mzs), lazy=False)
    )


def main():
    new_axis = np.loadtxt(sys.argv[1])
    resampling_pipeline(new_axis)(sys.argv[2:])


if __name__ == '__main__':
    main()
